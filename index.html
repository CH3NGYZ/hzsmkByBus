<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>正在跳转...</title>
  <style>
    body { font-family: sans-serif; padding: 2em; text-align: center; }
    .loading { font-size: 1.2em; color: #444; }
    .error { color: red; white-space: pre-wrap; text-align: left; max-width: 600px; margin: 1em auto; }
  </style>
</head>
<body>
  <p class="loading">正在获取 token 并跳转，请稍候...</p>
  <div class="error" id="errorBox" style="display:none;"></div>
  <script>
    function nativeXHRPost(url, data, headers = {}) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.timeout = 8000;
  
        for (const key in headers) {
          xhr.setRequestHeader(key, headers[key]);
        }
  
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const json = JSON.parse(xhr.responseText);
                resolve({ data: json });
              } catch (e) {
                reject(new Error('响应不是有效 JSON：' + xhr.responseText));
              }
            } else {
              reject(new Error('HTTP 错误：' + xhr.status + '\n' + xhr.responseText));
            }
          }
        };
  
        xhr.onerror = function () {
          reject(new Error('网络错误'));
        };
  
        xhr.send(JSON.stringify(data));
      });
    }
  
    function getQueryParam(key) {
      const queryString = window.location.search.substring(1);
      const params = queryString.split("&");
      for (let i = 0; i < params.length; i++) {
        const pair = params[i].split("=");
        if (decodeURIComponent(pair[0]) === key) {
          return decodeURIComponent(pair[1] || '');
        }
      }
      return null;
    }
  
    function showError(title, err) {
      const errorBox = document.getElementById('errorBox');
      const msg = [
        `❌ ${title}`,
        err?.message ? `错误信息: ${err.message}` : '',
        err?.response ? `状态码: ${err.response.status}\n响应体:\n${JSON.stringify(err.response.data, null, 2)}` : '',
        err?.stack ? `\n调用栈:\n${err.stack}` : ''
      ].filter(Boolean).join('\n\n');
  
      document.querySelector('.loading').style.display = 'none';
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }
  
    const accountToken = getQueryParam('token');
  
    async function getHzrckToken(channelToken) {
      document.querySelector('.loading').innerHTML = '✅ 使用 channelToken 获取 hzrckToken...';
  
      try {
        const res = await nativeXHRPost(
          'https://talent.hzrcm.cn/smk_hztalent/front/app/home/getHzrckToken',
          {
            channelToken: channelToken,
            channel: 'smk_app'
          },
          {
            'Content-Type': 'application/json;charset=UTF-8',
            'sendClient': 'hellohzsmk',
            'sendChl': 'hzsmk.h5',
            'Origin': 'https://talent.hzrcm.cn',
            'X-Requested-With': 'com.smk',
            'Referer': 'https://talent.hzrcm.cn/exthtml/hangZhouTalentCard/index.html'
          }
        );
        return res.data;
      } catch (err) {
        throw err;
      }
    }
  
    async function changeToken(token) {
      document.querySelector('.loading').innerHTML = '✅ 正在换取 channelToken...';
  
      try {
        const res = await nativeXHRPost(
          'https://open.iconntech.com/unifyUser/changeToken',
          {
            appId: '413201297836154880',
            token: token
          },
          {
            'Content-Type': 'application/json',
            'Origin': 'https://talent.hzrcm.cn',
            'X-Requested-With': 'com.smk',
            'Referer': 'https://talent.hzrcm.cn/'
          }
        );
        const newChannelToken = res.data?.data;
        if (!newChannelToken) throw new Error('未获取到 channelToken');
        localStorage.setItem('channelToken', newChannelToken);
        return newChannelToken;
      } catch (err) {
        throw err;
      }
    }
  
    (async () => {
      if (!accountToken) {
        document.querySelector('.loading').innerHTML = '<span class="error">❌ 缺少 token 参数</span>';
        return;
      }
  
      let channelToken = localStorage.getItem('channelToken');
  
      try {
        if (channelToken) {
          // 有缓存token，先用它获取 hzrckToken
          const res = await getHzrckToken(channelToken);
          if (res?.code === 'PY0000') {
            // 成功，跳转
            const hzrckToken = res.response?.hzrckToken;
            if (!hzrckToken) throw new Error('未获取到 hzrckToken');
            const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
            document.querySelector('.loading').innerHTML =
              `✅ 使用缓存 channelToken 成功，即将跳转到：<br><a href="${jumpUrl}">${jumpUrl}</a><br>`;
            window.location.href = jumpUrl;
            return;
          } else {
            // code 不对，换token重新获取
            channelToken = await changeToken(accountToken);
            const res2 = await getHzrckToken(channelToken);
            if (res2?.code === 'PY0000') {
              const hzrckToken = res2.response?.hzrckToken;
              if (!hzrckToken) throw new Error('未获取到 hzrckToken');
              const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
              document.querySelector('.loading').innerHTML =
                `✅ 换取新 channelToken 并成功获取 hzrckToken，即将跳转到：<br><a href="${jumpUrl}">${jumpUrl}</a><br>`;
              window.location.href = jumpUrl;
              return;
            } else {
              throw new Error(`获取 hzrckToken 失败，code: ${res2.code}`);
            }
          }
        } else {
          // 没有缓存 channelToken，正常流程
          channelToken = await changeToken(accountToken);
          const res2 = await getHzrckToken(channelToken);
          if (res2?.code === 'PY0000') {
            const hzrckToken = res2.response?.hzrckToken;
            if (!hzrckToken) throw new Error('未获取到 hzrckToken');
            const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
            document.querySelector('.loading').innerHTML =
              `✅ 正常流程完成，即将跳转到：<br><a href="${jumpUrl}">${jumpUrl}</a><br>`;
            window.location.href = jumpUrl;
            return;
          } else {
            throw new Error(`获取 hzrckToken 失败，code: ${res2.code}`);
          }
        }
      } catch (err) {
        showError('跳转失败', err);
      }
    })();
  </script>

</body>
</html>
