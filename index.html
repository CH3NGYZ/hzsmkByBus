<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>å…¬äº¤å¡é¢åº¦æ˜¾ç¤ºåŠåµŒå…¥é¡µé¢</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: #fff;
    }
    #container, #infoBox {
      width: 100%;
      max-width: 1440px;
      box-sizing: border-box;
    }
    #container {
      flex: 1;
      height: 100%;
    }
    #webview {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
    }
    #infoBox {
      background: #f5f5f5;
      border-top: 1px solid #ccc;
      padding: 0.8em 1em;
      font-size: 1.1em;
      color: #333;
      text-align: center;
    }
    #errorBox {
      color: red;
      white-space: pre-wrap;
      max-width: 1440px;
      margin: 1em auto;
      display: none;
      text-align: left;
    }
  </style>
</head>
<body>
  <div id="container">
    <iframe id="webview" src="about:blank"></iframe>
  </div>
  <div id="infoBox">æ­£åœ¨è·å–å…¬äº¤å¡é¢åº¦...</div>
  <div id="errorBox"></div>

  <script>
    function nativeXHRPost(url, data, headers = {}) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.timeout = 8000;
        for (const key in headers) {
          xhr.setRequestHeader(key, headers[key]);
        }
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const json = JSON.parse(xhr.responseText);
                resolve({ data: json });
              } catch (e) {
                reject(new Error('å“åº”ä¸æ˜¯æœ‰æ•ˆ JSONï¼š' + xhr.responseText));
              }
            } else {
              reject(new Error('HTTP é”™è¯¯ï¼š' + xhr.status + '\n' + xhr.responseText));
            }
          }
        };
        xhr.onerror = function () {
          reject(new Error('ç½‘ç»œé”™è¯¯'));
        };
        xhr.send(JSON.stringify(data));
      });
    }

    function getQueryParam(key) {
      const queryString = window.location.search.substring(1);
      const params = queryString.split("&");
      for (let i = 0; i < params.length; i++) {
        const pair = params[i].split("=");
        if (decodeURIComponent(pair[0]) === key) {
          return decodeURIComponent(pair[1] || '');
        }
      }
      return null;
    }

    function showError(title, err) {
      const errorBox = document.getElementById('errorBox');
      const infoBox = document.getElementById('infoBox');
      const msg = [
        `âŒ ${title}`,
        err?.message ? `é”™è¯¯ä¿¡æ¯: ${err.message}` : '',
        err?.response ? `çŠ¶æ€ç : ${err.response.status}\nå“åº”ä½“:\n${JSON.stringify(err.response.data, null, 2)}` : '',
        err?.stack ? `\nè°ƒç”¨æ ˆ:\n${err.stack}` : ''
      ].filter(Boolean).join('\n\n');

      infoBox.textContent = '';
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }

    async function getCouponInfo(hzrckToken, jumpUrl) {
      const infoBox = document.getElementById('infoBox');
      infoBox.textContent = 'âœ… æ­£åœ¨è·å–å…¬äº¤å¡é¢åº¦...';

      try {
        const res = await nativeXHRPost(
          'https://talent.hzrcm.cn/smk_hztalent_stu/front/app/qinghe/getUserCouponList',
          { accessToken: hzrckToken },
          {
            'Content-Type': 'application/json;charset=UTF-8',
            'sendClient': 'hellohzsmk',
            'sendChl': 'hzsmk.h5',
            'Origin': 'https://talent.hzrcm.cn',
            'X-Requested-With': 'com.smk',
            'Referer': 'https://talent.hzrcm.cn/exthtml/youngTalentCard/hzYouthTalentCard/',
          }
        );

        if (res.data?.code === 'PY0000') {
          const list = res.data.response?.[0]?.list || [];
          const subwayItem = list.find(item => item.couponUseType === 'subway');
          const title = subwayItem?.couponTitle || 'æœªçŸ¥é¢åº¦';
          const expire = subwayItem?.expireEndTime || 'æœªçŸ¥æœ‰æ•ˆæœŸ';

          infoBox.innerHTML =
            `ğŸ« å…¬äº¤å¡é¢åº¦ï¼š<strong>${title}</strong> <br>ğŸ“… æœ‰æ•ˆæœŸè‡³ï¼š<strong>${expire}</strong>`;

          document.getElementById('webview').src = jumpUrl;
        } else {
          throw new Error('è·å–å…¬äº¤å¡é¢åº¦å¤±è´¥ï¼Œcode: ' + res.data?.code);
        }
      } catch (err) {
        showError('è·å–å…¬äº¤å¡é¢åº¦å¤±è´¥', err);
        throw err;
      }
    }

    async function getHzrckToken(channelToken) {
      const res = await nativeXHRPost(
        'https://talent.hzrcm.cn/smk_hztalent/front/app/home/getHzrckToken',
        {
          channelToken: channelToken,
          channel: 'smk_app'
        },
        {
          'Content-Type': 'application/json;charset=UTF-8',
          'sendClient': 'hellohzsmk',
          'sendChl': 'hzsmk.h5',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/exthtml/hangZhouTalentCard/index.html'
        }
      );
      return res.data;
    }

    async function getHzrckToken(channelToken) {
      const res = await nativeXHRPost(
        'https://talent.hzrcm.cn/smk_hztalent/front/app/home/getHzrckToken',
        {
          channelToken: channelToken,
          channel: 'smk_app'
        },
        {
          'Content-Type': 'application/json;charset=UTF-8',
          'sendClient': 'hellohzsmk',
          'sendChl': 'hzsmk.h5',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/exthtml/hangZhouTalentCard/index.html'
        }
      );
      return res.data;
    }

    async function changeToken(token) {
      const res = await nativeXHRPost(
        'https://open.iconntech.com/unifyUser/changeToken',
        {
          appId: '413201297836154880',
          token: token
        },
        {
          'Content-Type': 'application/json',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/'
        }
      );
      const newChannelToken = res.data?.data;
      if (!newChannelToken) throw new Error('æœªè·å–åˆ° channelToken');
      localStorage.setItem('channelToken', newChannelToken);
      return newChannelToken;
    }

    const accountToken = getQueryParam('token');

    (async () => {
      if (!accountToken) {
        document.getElementById('infoBox').textContent = '';
        showError('ç¼ºå°‘ token å‚æ•°', new Error('URL å‚æ•°ä¸­æœªæ‰¾åˆ° token'));
        return;
      }

      let channelToken = localStorage.getItem('channelToken');
      let hzrckToken;

      try {
        if (channelToken) {
          const res = await getHzrckToken(channelToken);
          if (res?.code === 'PY0000') {
            hzrckToken = res.response?.hzrckToken;
          }
        }

        if (!hzrckToken) {
          channelToken = await changeToken(accountToken);
          const res = await getHzrckToken(channelToken);
          if (res?.code !== 'PY0000') throw new Error('ä½¿ç”¨æ–° channelToken è·å– hzrckToken å¤±è´¥');
          hzrckToken = res.response?.hzrckToken;
        }

        if (!hzrckToken) throw new Error('æœªè·å–åˆ° hzrckToken');

        const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
        await getCouponInfo(hzrckToken, jumpUrl);
      } catch (err) {
        showError('åŠ è½½å¤±è´¥', err);
      }
    })();
  </script>
</body>
</html>
