<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#4CAF50">
  <title>å…¬äº¤å¡é¢åº¦æ˜¾ç¤º</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
    }
    #webview {
      flex: 1 1 auto;
      border: none;
      width: 100%;
      max-width: 100vw;
    }
    #infoBox {
      flex: 0 0 auto;
      background: #f5f5f5;
      border-top: 1px solid #ccc;
      padding: 0.8em 1em;
      font-size: 1.2em;
      color: #333;
      text-align: center;
      box-sizing: border-box;
      width: 100%;
      max-width: 100vw;
    }
    #errorBox {
      color: red;
      white-space: pre-wrap;
      max-width: 600px;
      margin: 1em auto;
      display: none;
      text-align: left;
    }
    #logContainer {
      flex: 0 0 auto;
      background: #1e1e1e;
      border-top: 1px solid #333;
      display: flex;
      flex-direction: column;
      max-height: 50vh;
      transition: max-height 0.3s ease;
    }
    #logContainer.collapsed {
      max-height: 40px;
    }
    #logHeader {
      background: #252526;
      color: #cccccc;
      padding: 0.5em 1em;
      cursor: pointer;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85em;
      border-bottom: 1px solid #333;
      font-family: 'Consolas', 'Monaco', monospace;
    }
    #logHeader:hover {
      background: #2d2d30;
    }
    #logLatest {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin-right: 1em;
    }
    #logArrow {
      transition: transform 0.3s ease;
      font-size: 1.2em;
      flex-shrink: 0;
    }
    #logContainer.collapsed #logArrow {
      transform: rotate(180deg);
    }
    #logBox {
      background: #1e1e1e;
      color: #d4d4d4;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 0.85em;
      padding: 0.5em;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-all;
      flex: 1;
      min-height: 0;
    }
    #logContainer.collapsed #logBox {
      display: none;
    }
    .log-item {
      padding: 2px 0;
      border-bottom: 1px solid #2a2a2a;
    }
    .log-info { color: #4ec9b0; }
    .log-warn { color: #dcdcaa; }
    .log-error { color: #f48771; }
    .log-success { color: #6a9955; }
  </style>
</head>
<body>
  <iframe id="webview" src="about:blank"></iframe>
  <div id="infoBox">æ­£åœ¨è·å–å…¬äº¤å¡é¢åº¦...</div>
  <div id="errorBox"></div>
  <div id="logContainer" class="collapsed">
    <div id="logHeader">
      <span id="logLatest">ç­‰å¾…æ—¥å¿—...</span>
      <span id="logArrow">â–¼</span>
    </div>
    <div id="logBox"></div>
  </div>

  <script>
    // ========== åŠ¨æ€ç”Ÿæˆ PWA Manifest ==========
    function generateManifest() {
      const token = getQueryParam('token');
      if (!token) return;
      
      // æ„å»ºå¸¦ token çš„å®Œæ•´ URL
      const currentUrl = new URL(window.location.href);
      const startUrl = `${currentUrl.origin}${currentUrl.pathname}?token=${token}`;
      
      // ç”Ÿæˆ PNG å›¾æ ‡ï¼ˆå…¼å®¹æ€§æ›´å¥½ï¼‰
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // ç”Ÿæˆ 192x192 å›¾æ ‡
      canvas.width = 192;
      canvas.height = 192;
      ctx.fillStyle = '#4CAF50';
      ctx.fillRect(0, 0, 192, 192);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 120px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('ğŸšŒ', 96, 100);
      const icon192 = canvas.toDataURL('image/png');
      
      // ç”Ÿæˆ 512x512 å›¾æ ‡
      canvas.width = 512;
      canvas.height = 512;
      ctx.fillStyle = '#4CAF50';
      ctx.fillRect(0, 0, 512, 512);
      ctx.fillStyle = '#ffffff';
      ctx.font = 'bold 320px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText('ğŸšŒ', 256, 266);
      const icon512 = canvas.toDataURL('image/png');
      
      const manifest = {
        "name": "æ­å·å…¬äº¤å¡",
        "short_name": "å…¬äº¤å¡",
        "description": "æ­å·äººæ‰å¡å…¬äº¤é¢åº¦æŸ¥è¯¢",
        "start_url": startUrl,
        "scope": "/",
        "display": "standalone",
        "background_color": "#ffffff",
        "theme_color": "#4CAF50",
        "orientation": "portrait",
        "icons": [
          {
            "src": icon192,
            "sizes": "192x192",
            "type": "image/png",
            "purpose": "any"
          },
          {
            "src": icon192,
            "sizes": "192x192",
            "type": "image/png",
            "purpose": "maskable"
          },
          {
            "src": icon512,
            "sizes": "512x512",
            "type": "image/png",
            "purpose": "any"
          },
          {
            "src": icon512,
            "sizes": "512x512",
            "type": "image/png",
            "purpose": "maskable"
          }
        ]
      };
      
      // å°† manifest è½¬æ¢ä¸º Blob URL
      const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
      const manifestURL = URL.createObjectURL(manifestBlob);
      
      // åŠ¨æ€æ’å…¥ manifest link
      const link = document.createElement('link');
      link.rel = 'manifest';
      link.href = manifestURL;
      document.head.appendChild(link);
      
      // æ·»åŠ  faviconï¼ˆä½¿ç”¨ 192 å›¾æ ‡ï¼‰
      const favicon = document.createElement('link');
      favicon.rel = 'icon';
      favicon.href = icon192;
      document.head.appendChild(favicon);
      
      // æ·»åŠ è‹¹æœè®¾å¤‡æ”¯æŒï¼ˆä½¿ç”¨ 192 å›¾æ ‡ï¼‰
      const appleTouchIcon = document.createElement('link');
      appleTouchIcon.rel = 'apple-touch-icon';
      appleTouchIcon.href = icon192;
      document.head.appendChild(appleTouchIcon);
      
      const appleCapable = document.createElement('meta');
      appleCapable.name = 'apple-mobile-web-app-capable';
      appleCapable.content = 'yes';
      document.head.appendChild(appleCapable);
      
      const appleTitle = document.createElement('meta');
      appleTitle.name = 'apple-mobile-web-app-title';
      appleTitle.content = 'å…¬äº¤å¡';
      document.head.appendChild(appleTitle);
      
      const appleStatus = document.createElement('meta');
      appleStatus.name = 'apple-mobile-web-app-status-bar-style';
      appleStatus.content = 'default';
      document.head.appendChild(appleStatus);
      
      console.log('âœ… PWA Manifest å·²åŠ¨æ€ç”Ÿæˆ');
      console.log('ğŸ“± Start URL:', startUrl);
      
      // å»¶è¿Ÿæ£€æŸ¥ beforeinstallprompt äº‹ä»¶
      let deferredPrompt;
      window.addEventListener('beforeinstallprompt', (e) => {
        console.log('ğŸ‰ beforeinstallprompt äº‹ä»¶è§¦å‘ï¼Œåº”ç”¨å¯ä»¥å®‰è£…');
        deferredPrompt = e;
      });
    }

    // ========== æ—¥å¿—å±•å¼€/æ”¶èµ·åŠŸèƒ½ ==========
    const logContainer = document.getElementById('logContainer');
    const logHeader = document.getElementById('logHeader');
    
    logHeader.addEventListener('click', () => {
      logContainer.classList.toggle('collapsed');
    });

    // ========== æ—¥å¿—è¾“å‡ºåˆ°é¡µé¢åº•éƒ¨ ==========
    const logBox = document.getElementById('logBox');
    const logLatest = document.getElementById('logLatest');
    
    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
      const logItem = document.createElement('div');
      logItem.className = `log-item log-${type}`;
      const fullMessage = `[${timestamp}] ${message}`;
      logItem.textContent = fullMessage;
      logBox.appendChild(logItem);
      logBox.scrollTop = logBox.scrollHeight;
      
      // æ›´æ–°æ ‡é¢˜æ æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
      logLatest.textContent = fullMessage;
      logLatest.className = `log-${type}`;
    }

    // é‡å†™ console æ–¹æ³•ï¼ŒåŒæ—¶è¾“å‡ºåˆ°æµè§ˆå™¨æ§åˆ¶å°å’Œé¡µé¢
    const originalConsoleLog = console.log;
    const originalConsoleWarn = console.warn;
    const originalConsoleError = console.error;

    console.log = function(...args) {
      originalConsoleLog.apply(console, args);
      addLog(args.join(' '), 'info');
    };

    console.warn = function(...args) {
      originalConsoleWarn.apply(console, args);
      addLog(args.join(' '), 'warn');
    };

    console.error = function(...args) {
      originalConsoleError.apply(console, args);
      addLog(args.join(' '), 'error');
    };

    // ========== ç¼“å­˜ç®¡ç†å·¥å…· ==========
    const cache = {
      get(key) {
        try {
          const item = localStorage.getItem(key);
          if (!item) return null;
          return item;
        } catch {
          return null;
        }
      },
      set(key, value) {
        try {
          localStorage.setItem(key, value);
        } catch (e) {
          console.warn('ç¼“å­˜å†™å…¥å¤±è´¥:', e);
        }
      },
      remove(key) {
        try {
          localStorage.removeItem(key);
        } catch (e) {
          console.warn('ç¼“å­˜åˆ é™¤å¤±è´¥:', e);
        }
      }
    };

    // ========== ç½‘ç»œè¯·æ±‚å·¥å…· ==========
    function nativeXHRPost(url, data, headers = {}) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', url, true);
        xhr.timeout = 8000;

        for (const key in headers) {
          xhr.setRequestHeader(key, headers[key]);
        }

        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status >= 200 && xhr.status < 300) {
              try {
                const json = JSON.parse(xhr.responseText);
                resolve({ data: json });
              } catch (e) {
                reject(new Error('å“åº”ä¸æ˜¯æœ‰æ•ˆ JSONï¼š' + xhr.responseText));
              }
            } else {
              reject(new Error('HTTP é”™è¯¯ï¼š' + xhr.status + '\n' + xhr.responseText));
            }
          }
        };

        xhr.onerror = function () {
          reject(new Error('ç½‘ç»œé”™è¯¯'));
        };

        xhr.send(JSON.stringify(data));
      });
    }

    // ========== URL å‚æ•°è§£æ ==========
    function getQueryParam(key) {
      const queryString = window.location.search.substring(1);
      const params = queryString.split("&");
      for (let i = 0; i < params.length; i++) {
        const pair = params[i].split("=");
        if (decodeURIComponent(pair[0]) === key) {
          return decodeURIComponent(pair[1] || '');
        }
      }
      return null;
    }

    // ========== é”™è¯¯æ˜¾ç¤º ==========
    function showError(title, err) {
      const errorBox = document.getElementById('errorBox');
      const infoBox = document.getElementById('infoBox');
      const msg = [
        `âŒ ${title}`,
        err?.message ? `é”™è¯¯ä¿¡æ¯: ${err.message}` : '',
        err?.response ? `çŠ¶æ€ç : ${err.response.status}\nå“åº”ä½“:\n${JSON.stringify(err.response.data, null, 2)}` : '',
        err?.stack ? `\nè°ƒç”¨æ ˆ:\n${err.stack}` : ''
      ].filter(Boolean).join('\n\n');

      infoBox.textContent = '';
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }

    function updateStatus(msg) {
      document.getElementById('infoBox').textContent = msg;
    }

    // ========== æ ¸å¿ƒä¸šåŠ¡å‡½æ•° ==========
    async function getCouponInfo(hzrckToken, jumpUrl) {
      updateStatus('âœ… æ­£åœ¨è·å–å…¬äº¤å¡é¢åº¦...');

      const res = await nativeXHRPost(
        'https://talent.hzrcm.cn/smk_hztalent_stu/front/app/qinghe/getUserCouponList',
        { accessToken: hzrckToken },
        {
          'Content-Type': 'application/json;charset=UTF-8',
          'sendClient': 'hellohzsmk',
          'sendChl': 'hzsmk.h5',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/exthtml/youngTalentCard/hzYouthTalentCard/',
        }
      );

      if (res.data?.code === 'PY0000') {
        const list = res.data.response?.[0]?.list || [];
        const subwayItem = list.find(item => item.couponUseType === 'subway');
        const titleRaw = subwayItem?.couponTitle || 'æœªçŸ¥é¢åº¦';
        const title = titleRaw.match(/\d+(?:\.\d+)?/)?.[0] || 'æœªçŸ¥é¢åº¦';
        const expire = subwayItem?.expireEndTime || 'æœªçŸ¥æœ‰æ•ˆæœŸ';
        
        document.getElementById('infoBox').innerHTML = 
          `ğŸ« å…¬äº¤å¡å‰©ï¼š<strong>${title} å…ƒ</strong><br>ğŸ“… æœ‰æ•ˆæœŸè‡³ï¼š<strong>${expire}</strong>`;

        document.getElementById('webview').src = jumpUrl;
        return true;
      } else {
        throw new Error('è·å–å…¬äº¤å¡é¢åº¦å¤±è´¥ï¼Œcode: ' + res.data?.code);
      }
    }

    async function getHzrckToken(channelToken) {
      updateStatus('âœ… ä½¿ç”¨ channelToken è·å– hzrckToken...');
      const res = await nativeXHRPost(
        'https://talent.hzrcm.cn/smk_hztalent/front/app/home/getHzrckToken',
        {
          channelToken: channelToken,
          channel: 'smk_app'
        },
        {
          'Content-Type': 'application/json;charset=UTF-8',
          'sendClient': 'hellohzsmk',
          'sendChl': 'hzsmk.h5',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/exthtml/hangZhouTalentCard/index.html'
        }
      );
      return res.data;
    }

    async function changeToken(token) {
      updateStatus('âœ… æ­£åœ¨æ¢å– channelToken...');

      const res = await nativeXHRPost(
        'https://open.iconntech.com/unifyUser/changeToken',
        {
          appId: '413201297836154880',
          token: token
        },
        {
          'Content-Type': 'application/json',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/'
        }
      );
      const newChannelToken = res.data?.data;
      if (!newChannelToken) throw new Error('æœªè·å–åˆ° channelToken');
      return newChannelToken;
    }

    // ========== ä¸»æµç¨‹ï¼ˆå¸¦ç¼“å­˜ä¼˜åŒ–ï¼‰ ==========
    (async () => {
      const accountToken = getQueryParam('token');
      
      // å…ˆç”Ÿæˆ PWA Manifest
      generateManifest();
      
      if (!accountToken) {
        updateStatus('');
        showError('ç¼ºå°‘ token å‚æ•°', new Error('URL å‚æ•°ä¸­æœªæ‰¾åˆ° token'));
        return;
      }

      try {
        // ===== æ­¥éª¤ 1: å°è¯•ä½¿ç”¨ç¼“å­˜çš„ hzrckToken =====
        const cachedHzrckToken = cache.get('hzrckToken');
        
        if (cachedHzrckToken) {
          updateStatus('ğŸš€ ä½¿ç”¨ç¼“å­˜çš„ Token å¿«é€ŸåŠ è½½...');
          try {
            const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${cachedHzrckToken}`;
            await getCouponInfo(cachedHzrckToken, jumpUrl);
            console.log('âœ… ç¼“å­˜çš„ hzrckToken ä»ç„¶æœ‰æ•ˆ');
            return; // æˆåŠŸåˆ™ç›´æ¥ç»“æŸ
          } catch (err) {
            console.warn('âš ï¸ ç¼“å­˜çš„ hzrckToken å·²å¤±æ•ˆï¼Œé‡æ–°è·å–', err.message);
            cache.remove('hzrckToken');
          }
        }

        // ===== æ­¥éª¤ 2: å°è¯•ä½¿ç”¨ç¼“å­˜çš„ channelToken =====
        let channelToken = cache.get('channelToken');
        let hzrckToken;

        if (channelToken) {
          try {
            const res = await getHzrckToken(channelToken);
            if (res?.code === 'PY0000') {
              hzrckToken = res.response?.hzrckToken;
              console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„ channelToken æˆåŠŸè·å– hzrckToken');
            } else {
              console.warn('âš ï¸ channelToken è¿”å›å¼‚å¸¸ï¼Œæ¸…é™¤ç¼“å­˜');
              cache.remove('channelToken');
            }
          } catch (err) {
            console.warn('âš ï¸ ç¼“å­˜çš„ channelToken å·²å¤±æ•ˆ', err.message);
            cache.remove('channelToken');
          }
        }

        // ===== æ­¥éª¤ 3: ä½¿ç”¨ accountToken é‡æ–°è·å–å®Œæ•´é“¾è·¯ =====
        if (!hzrckToken) {
          channelToken = await changeToken(accountToken);
          cache.set('channelToken', channelToken);
          
          const res = await getHzrckToken(channelToken);
          if (res?.code !== 'PY0000') {
            throw new Error('ä½¿ç”¨æ–° channelToken è·å– hzrckToken å¤±è´¥');
          }
          hzrckToken = res.response?.hzrckToken;
          console.log('âœ… å®Œæ•´é“¾è·¯è·å– hzrckToken æˆåŠŸ');
        }

        if (!hzrckToken) {
          throw new Error('æœªè·å–åˆ° hzrckToken');
        }

        // ===== æ­¥éª¤ 4: ç¼“å­˜æ–°çš„ hzrckToken å¹¶æ˜¾ç¤ºé¢åº¦ =====
        cache.set('hzrckToken', hzrckToken);
        
        const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
        await getCouponInfo(hzrckToken, jumpUrl);

      } catch (err) {
        showError('åŠ è½½å¤±è´¥', err);
      }
    })();
  </script>
</body>
</html>