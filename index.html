<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>正在跳转...</title>
  <style>
    body { font-family: sans-serif; padding: 2em; text-align: center; }
    .loading { font-size: 1.2em; color: #444; }
    .error { color: red; }
  </style>
</head>
<body>
  <p class="loading">正在获取 token 并跳转，请稍候...</p>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    function getQueryParam(key) {
      const url = new URL(window.location.href);
      return url.searchParams.get(key);
    }

    const accountToken = getQueryParam('token');

    if (!accountToken) {
      document.querySelector('.loading').innerHTML = '<span class="error">❌ 缺少 token 参数</span>';
    } else {
      // 第一步：换取 channelToken
      axios.post(
        'https://open.iconntech.com/unifyUser/changeToken',
        {
          appId: '413201297836154880',
          token: accountToken
        },
        {
          headers: {
            'Content-Type': 'application/json',
            'Origin': 'https://talent.hzrcm.cn',
            'X-Requested-With': 'com.smk',
            'Referer': 'https://talent.hzrcm.cn/'
          }
        }
      )
      .then(res1 => {
        const channelToken = res1.data?.data;
        if (!channelToken) {
          throw new Error('未获取到 channelToken');
        }

        // 第二步：使用 channelToken 获取 hzrckToken
        return axios.post(
          'https://talent.hzrcm.cn/smk_hztalent/front/app/home/getHzrckToken',
          {
            channelToken: channelToken,
            channel: 'smk_app'
          },
          {
            headers: {
              'Content-Type': 'application/json;charset=UTF-8',
              'sendClient': 'hellohzsmk',
              'sendChl': 'hzsmk.h5',
              'Origin': 'https://talent.hzrcm.cn',
              'X-Requested-With': 'com.smk',
              'Referer': 'https://talent.hzrcm.cn/exthtml/hangZhouTalentCard/index.html'
            }
          }
        );
      })
      .then(res2 => {
        const hzrckToken = res2.data?.response?.hzrckToken;
        if (hzrckToken) {
          const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
          window.location.href = jumpUrl;
        } else {
          throw new Error('未获取到 hzrckToken');
        }
      })
      .catch(err => {
        console.error(err);
        document.querySelector('.loading').innerHTML = '<span class="error">❌ 获取 token 失败：' + err.message + '</span>';
      });
    }
  </script>
</body>
</html>
