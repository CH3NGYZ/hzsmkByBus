<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>正在跳转...</title>
  <style>
    body { font-family: sans-serif; padding: 2em; text-align: center; }
    .loading { font-size: 1.2em; color: #444; }
    .error { color: red; white-space: pre-wrap; text-align: left; max-width: 600px; margin: 1em auto; }
  </style>
</head>
<body>
  <p class="loading">正在获取 token 并跳转，请稍候...</p>
  <div class="error" id="errorBox" style="display:none;"></div>

  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    function getQueryParam(key) {
      const queryString = window.location.search.substring(1);
      const params = queryString.split("&");
      for (let i = 0; i < params.length; i++) {
        const pair = params[i].split("=");
        if (decodeURIComponent(pair[0]) === key) {
          return decodeURIComponent(pair[1] || '');
        }
      }
      return null;
    }

    function showError(title, err) {
      const errorBox = document.getElementById('errorBox');
      const msg = [
        `❌ ${title}`,
        err?.message ? `错误信息: ${err.message}` : '',
        err?.response ? `状态码: ${err.response.status}\n响应体:\n${JSON.stringify(err.response.data, null, 2)}` : '',
        err?.stack ? `\n调用栈:\n${err.stack}` : ''
      ].filter(Boolean).join('\n\n');

      document.querySelector('.loading').style.display = 'none';
      errorBox.style.display = 'block';
      errorBox.textContent = msg;
    }

    const accountToken = getQueryParam('token');
    document.querySelector('.loading').innerHTML = '✅ 获取 Token 参数成功';
    if (!accountToken) {
      document.querySelector('.loading').innerHTML = '<span class="error">❌ 缺少 token 参数</span>';
    } else {
      document.querySelector('.loading').innerHTML = '✅ 正在换取 channelToken...';

      nativeXHRPost(
        'https://open.iconntech.com/unifyUser/changeToken',
        {
          appId: '413201297836154880',
          token: accountToken
        },
        {
          'Content-Type': 'application/json',
          'Origin': 'https://talent.hzrcm.cn',
          'X-Requested-With': 'com.smk',
          'Referer': 'https://talent.hzrcm.cn/'
        }
      )
      .then(res1 => {
        const channelToken = res1.data?.data;
        if (!channelToken) {
          throw new Error('未获取到 channelToken');
        }
      
        document.querySelector('.loading').innerHTML = '✅ 正在获取 hzrckToken...';
      
        return nativeXHRPost(
          'https://talent.hzrcm.cn/smk_hztalent/front/app/home/getHzrckToken',
          {
            channelToken: channelToken,
            channel: 'smk_app'
          },
          {
            'Content-Type': 'application/json;charset=UTF-8',
            'sendClient': 'hellohzsmk',
            'sendChl': 'hzsmk.h5',
            'Origin': 'https://talent.hzrcm.cn',
            'X-Requested-With': 'com.smk',
            'Referer': 'https://talent.hzrcm.cn/exthtml/hangZhouTalentCard/index.html'
          }
        );
      })
      .then(res2 => {
        const hzrckToken = res2.data?.response?.hzrckToken;
        if (hzrckToken) {
          const jumpUrl = `https://hzrck.hzzhdj.cn/exthtml/youngTalentCard/freeCoderide/#/byBus?token=${hzrckToken}`;
      
          document.querySelector('.loading').innerHTML =
            `✅ 即将跳转到：<br><a href="${jumpUrl}">${jumpUrl}</a><br>`;
          window.location.href = jumpUrl;
        } else {
          throw new Error('未获取到 hzrckToken');
        }
      })
      .catch(err => {
        showError('跳转失败', err);
      });
    }
  </script>
</body>
</html>
